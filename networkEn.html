<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Cisco Web Terminal & Recovery Guide</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background-color: #1e1e1e;
        color: #d4d4d4;
        padding: 20px;
      }
      h1 {
        color: #4ec9b0;
        border-bottom: 2px solid #4ec9b0;
        padding-bottom: 10px;
      }
      .container {
        max-width: 1000px;
        margin: 0 auto;
        display: flex;
        gap: 20px;
      }

      /* Layout: Left (Terminal) & Right (Controls) */
      .left-panel {
        flex: 2;
      }
      .right-panel {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      /* Terminal Window */
      #terminal {
        width: 100%;
        height: 500px;
        background-color: #000;
        color: #0f0;
        border: 1px solid #555;
        overflow-y: scroll;
        padding: 10px;
        font-family: "Consolas", monospace;
        font-size: 14px;
        white-space: pre-wrap;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
      }

      /* Buttons & Inputs */
      button {
        background-color: #0e639c;
        color: white;
        border: none;
        padding: 10px;
        cursor: pointer;
        font-size: 13px;
        font-weight: bold;
        width: 100%;
        border-radius: 4px;
        transition: background 0.2s;
      }
      button:hover {
        background-color: #1177bb;
      }
      button:disabled {
        background-color: #3c3c3c;
        color: #777;
        cursor: not-allowed;
      }

      .break-btn {
        background-color: #c94e4e;
        margin-top: 5px;
      }
      .break-btn:hover {
        background-color: #e63535;
      }

      .input-area {
        display: flex;
        gap: 5px;
        margin-top: 10px;
      }
      input[type="text"] {
        flex-grow: 1;
        padding: 8px;
        background: #333;
        color: white;
        border: 1px solid #555;
        font-family: "Consolas", monospace;
      }

      /* Guide Box Styles */
      .cmd-group {
        border: 1px solid #444;
        padding: 15px;
        background: #252526;
        border-radius: 8px;
      }
      .cmd-group h3 {
        margin-top: 0;
        margin-bottom: 10px;
        color: #dcdcaa;
        border-bottom: 1px solid #444;
        padding-bottom: 5px;
      }

      /* Step-by-step Instructions */
      .steps {
        font-size: 12px;
        color: #ccc;
        margin-bottom: 10px;
        padding-left: 20px;
      }
      .steps li {
        margin-bottom: 4px;
      }
      .warning {
        color: #ce9178;
        font-weight: bold;
      }
      .highlight {
        color: #4ec9b0;
      }

      /* Connection Status */
      .status-bar {
        padding: 10px;
        background: #333;
        margin-bottom: 10px;
        border-radius: 4px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
    </style>
  </head>
  <body>
    <div style="max-width: 1000px; margin: 0 auto">
      <h1>Cisco Lab Recovery Assistant</h1>

      <div class="status-bar">
        <span id="statusText">ðŸ”´ Status: Disconnected</span>
        <button
          onclick="connectSerial()"
          style="width: auto; background: #4ec9b0; color: black"
        >
          ðŸ”Œ Connect Device
        </button>
      </div>
    </div>

    <div class="container">
      <div class="left-panel">
        <div id="terminal">Welcome! Click 'Connect Device' to start.</div>

        <div class="input-area">
          <input
            type="text"
            id="manualInput"
            placeholder="Manual command..."
            disabled
            onkeydown="handleInput(event)"
          />
          <button
            id="btnSend"
            style="width: 80px"
            onclick="sendManualCommand()"
            disabled
          >
            Send
          </button>
        </div>
        <button
          id="btnBreak"
          class="break-btn"
          onclick="sendBreakSignal()"
          disabled
        >
          âš¡ SEND BREAK (Ctrl+C)
        </button>
        <p style="font-size: 12px; color: #888; margin-top: 5px">
          * Use 'SEND BREAK' repeatedly during router boot to enter ROMMON.
        </p>
      </div>

      <div class="right-panel">
        <div class="cmd-group">
          <h3>1. Router Recovery</h3>
          <ul class="steps">
            <li>Turn <span class="warning">OFF</span> the router.</li>
            <li>Turn it <span class="highlight">ON</span>.</li>
            <li>
              Immediately click <b>[âš¡ SEND BREAK]</b> repeatedly until
              <code class="highlight">rommon 1 ></code> appears[cite: 7, 8].
            </li>
            <li>Then click the button below.</li>
          </ul>
          <button id="btnRouter" onclick="runRouterRecovery()" disabled>
            â–¶ Start Router Recovery
          </button>
        </div>

        <div class="cmd-group">
          <h3>2. Switch Reset (2960/C1000)</h3>
          <ul class="steps">
            <li>Unplug the power cable[cite: 89].</li>
            <li>
              Press & Hold the <b class="highlight">MODE</b> button[cite: 90].
            </li>
            <li>Plug power back in.</li>
            <li>
              <b>Keep holding MODE</b> for 15 seconds until
              <code class="highlight">switch:</code> appears[cite: 91].
            </li>
          </ul>
          <button id="btnSwitch" onclick="runSwitchReset()" disabled>
            â–¶ Start Switch Reset
          </button>
        </div>

        <div class="cmd-group">
          <h3>3. Catalyst 9200 Recovery</h3>
          <ul class="steps">
            <li>Unplug the power cable[cite: 214].</li>
            <li>
              Press & Hold the <b class="highlight">MODE</b> button[cite: 215].
            </li>
            <li>Plug power back in.</li>
            <li>
              <b>Keep holding MODE</b> for 15 seconds until
              <code class="highlight">switch:</code> appears[cite: 216].
            </li>
          </ul>
          <button id="btn9200" onclick="run9200Recovery()" disabled>
            â–¶ Start 9200 Recovery
          </button>
        </div>
      </div>
    </div>

    <script>
      let port, writer, reader;
      let globalBuffer = "";

      async function connectSerial() {
        if (!navigator.serial) {
          alert("Use Chrome/Edge.");
          return;
        }
        try {
          port = await navigator.serial.requestPort();
          await port.open({ baudRate: 9600 });
          logToTerminal("[SYSTEM] Connected successfully.");
          document.getElementById("statusText").innerText =
            "ðŸŸ¢ Status: Connected";
          toggleUI(false);
          readLoop();
        } catch (err) {
          logToTerminal("[ERROR] " + err);
        }
      }

      function toggleUI(disabled) {
        const ids = [
          "manualInput",
          "btnSend",
          "btnBreak",
          "btnRouter",
          "btnSwitch",
          "btn9200",
        ];
        ids.forEach((id) => (document.getElementById(id).disabled = disabled));
      }

      async function readLoop() {
        const textDecoder = new TextDecoderStream();
        port.readable.pipeTo(textDecoder.writable);
        reader = textDecoder.readable.getReader();
        try {
          while (true) {
            const { value, done } = await reader.read();
            if (done) break;
            if (value) {
              globalBuffer += value;
              logToTerminal(value, true);
            }
          }
        } catch (e) {
          console.error(e);
        }
      }

      async function writeToStream(data) {
        const textEncoder = new TextEncoderStream();
        const writableStreamClosed = textEncoder.readable.pipeTo(port.writable);
        const writer = textEncoder.writable.getWriter();
        await writer.write(data + "\r");
        writer.close();
      }

      async function sendBreakSignal() {
        if (!port) return;
        logToTerminal("\n[SYSTEM] Sending BREAK Signal...");
        await port.setSignals({ break: true });
        await new Promise((r) => setTimeout(r, 250));
        await port.setSignals({ break: false });
      }

      function handleInput(e) {
        if (e.key === "Enter") sendManualCommand();
      }
      async function sendManualCommand() {
        const input = document.getElementById("manualInput");
        if (input.value) {
          await writeToStream(input.value);
          input.value = "";
        }
      }

      async function wait(pattern, timeoutSec = 30) {
        logToTerminal(`\n[WAITING] "${pattern}"...`);
        const start = Date.now();
        while (Date.now() - start < timeoutSec * 1000) {
          if (globalBuffer.includes(pattern)) {
            globalBuffer = "";
            return true;
          }
          await new Promise((r) => setTimeout(r, 100));
        }
        logToTerminal("\n[TIMEOUT]");
        return false;
      }

      function logToTerminal(msg, isRaw = false) {
        const term = document.getElementById("terminal");
        term.textContent += isRaw ? msg : "\n" + msg;
        term.scrollTop = term.scrollHeight;
      }

      // --- Procedures (Logic unchanged) ---
      async function runRouterRecovery() {
        if (!confirm("Start Router Recovery?")) return;
        await writeToStream("confreg 0x2142");
        if (!(await wait("rommon 2 >"))) return;
        await writeToStream("reset");
        logToTerminal("[INFO] Rebooting... (Wait for dialog)");
        if (!(await wait("initial configuration dialog", 600))) return;
        await writeToStream("no");
        if (!(await wait("Router>"))) return;
        await writeToStream("enable");
        if (!(await wait("Router#"))) return;
        await writeToStream("write erase");
        if (!(await wait("confirm"))) return;
        await writeToStream("");
        await new Promise((r) => setTimeout(r, 2000));
        await writeToStream("conf t");
        if (!(await wait("(config)#"))) return;
        await writeToStream("config-register 0x2102");
        await writeToStream("end");
        if (!(await wait("Router#"))) return;
        await writeToStream("reload");
        if (!(await wait("modified"))) return;
        await writeToStream("no");
        if (!(await wait("proceed"))) return;
        await writeToStream("");
        alert("Finished!");
      }

      async function runSwitchReset() {
        if (!confirm("Start Switch Reset?")) return;
        await writeToStream("delete flash:vlan.dat");
        if (!(await wait("(y/n)?"))) return;
        await writeToStream("y");
        await writeToStream("delete flash:config.text");
        if (!(await wait("(y/n)?"))) return;
        await writeToStream("y");
        await writeToStream("delete flash:private-config.text");
        await new Promise((r) => setTimeout(r, 1000));
        await writeToStream("y");
        await writeToStream("reset");
        if (!(await wait("(y/n)?"))) return;
        await writeToStream("y");
        alert("Rebooting...");
      }

      async function run9200Recovery() {
        if (!confirm("Start 9200 Recovery?")) return;
        await writeToStream("SWITCH_IGNORE_STARTUP_CFG=1");
        await new Promise((r) => setTimeout(r, 500));
        await writeToStream("boot");
        logToTerminal("[INFO] Booting (5-10 mins)...");
        if (!(await wait("Switch>", 600))) return;
        await writeToStream("en");
        if (!(await wait("Switch#"))) return;
        await writeToStream("write erase");
        if (!(await wait("confirm"))) return;
        await writeToStream("");
        await writeToStream("conf t");
        if (!(await wait("(config)#"))) return;
        await writeToStream("no system ignore startupconfig switch all");
        await writeToStream("exit");
        if (!(await wait("Switch#"))) return;
        await writeToStream("write memory");
        await new Promise((r) => setTimeout(r, 3000));
        await writeToStream("reload");
        await new Promise((r) => setTimeout(r, 2000));
        await writeToStream("no");
        await writeToStream("");
        alert("Finished!");
      }
    </script>
  </body>
</html>
