<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>Cisco Lab Auto-Recovery Tool</title>
    <style>
      body {
        font-family: "Consolas", monospace;
        background-color: #1e1e1e;
        color: #d4d4d4;
        padding: 20px;
      }
      h1 {
        color: #4ec9b0;
        border-bottom: 2px solid #4ec9b0;
        padding-bottom: 10px;
      }
      .container {
        max-width: 900px;
        margin: 0 auto;
      }

      /* í„°ë¯¸ë„ í™”ë©´ ìŠ¤íƒ€ì¼ */
      #terminal {
        width: 100%;
        height: 400px;
        background-color: #000;
        color: #0f0;
        border: 1px solid #555;
        overflow-y: scroll;
        padding: 10px;
        font-size: 14px;
        white-space: pre-wrap;
        margin-bottom: 20px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
      }

      /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
      button {
        background-color: #0e639c;
        color: white;
        border: none;
        padding: 10px 20px;
        margin: 5px;
        cursor: pointer;
        font-size: 14px;
        font-family: inherit;
        transition: background 0.3s;
      }
      button:hover {
        background-color: #1177bb;
      }
      button:disabled {
        background-color: #444;
        cursor: not-allowed;
      }

      .status-bar {
        margin-bottom: 15px;
        padding: 10px;
        background: #2d2d2d;
        border-radius: 4px;
      }
      .highlight {
        color: #ce9178;
        font-weight: bold;
      }
      .cmd-group {
        border: 1px solid #444;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 5px;
      }
      .cmd-group h3 {
        margin-top: 0;
        color: #dcdcaa;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Cisco Router & Switch Recovery Tool</h1>

      <div class="status-bar">
        <span id="statusText">ìƒíƒœ: ì—°ê²° ëŒ€ê¸° ì¤‘...</span>
        <button
          onclick="connectSerial()"
          style="
            float: right;
            margin-top: -5px;
            background: #4ec9b0;
            color: black;
            font-weight: bold;
          "
        >
          ğŸ”Œ ì¥ë¹„ ì—°ê²° (Connect)
        </button>
      </div>

      <div id="terminal"></div>

      <div class="cmd-group">
        <h3>1. Router Recovery (1941, 4221, etc)</h3>
        <p style="font-size: 12px; color: #888">
          * ROMMON 1 > í”„ë¡¬í”„íŠ¸ ìƒíƒœì—ì„œ ì‹œì‘í•˜ì„¸ìš”.
        </p>
        <button id="btnRouter" onclick="runRouterRecovery()" disabled>
          Start Router Recovery
        </button>
      </div>

      <div class="cmd-group">
        <h3>2. Standard Switch Reset (2960, C1000)</h3>
        <p style="font-size: 12px; color: #888">
          * switch: í”„ë¡¬í”„íŠ¸ ìƒíƒœì—ì„œ ì‹œì‘í•˜ì„¸ìš”.
        </p>
        <button id="btnSwitch" onclick="runSwitchReset()" disabled>
          Start Switch Reset
        </button>
      </div>

      <div class="cmd-group">
        <h3>3. Catalyst 9200 Recovery</h3>
        <p style="font-size: 12px; color: #888">
          * switch: í”„ë¡¬í”„íŠ¸ ìƒíƒœì—ì„œ ì‹œì‘í•˜ì„¸ìš”.
        </p>
        <button id="btn9200" onclick="run9200Recovery()" disabled>
          Start 9200 Recovery
        </button>
      </div>
    </div>

    <script>
      let port, writer, reader;
      let keepReading = false;
      let globalBuffer = ""; // ë“¤ì–´ì˜¤ëŠ” ë°ì´í„°ë¥¼ ìŒ“ì•„ë‘ëŠ” ë²„í¼

      // --- 1. ì‹œë¦¬ì–¼ ì—°ê²° ë¡œì§ ---
      async function connectSerial() {
        if (!navigator.serial) {
          alert(
            "ì´ ë¸Œë¼ìš°ì €ëŠ” Web Serial APIë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. í¬ë¡¬ì´ë‚˜ ì—£ì§€ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”."
          );
          return;
        }

        try {
          port = await navigator.serial.requestPort();
          await port.open({ baudRate: 9600 }); // ì‹œìŠ¤ì½” ê¸°ë³¸ê°’ 9600

          logToTerminal("[SYSTEM] Serial Port Connected Successfully.");
          document.getElementById("statusText").innerText =
            "ìƒíƒœ: ì—°ê²°ë¨ (9600bps)";

          // ë²„íŠ¼ í™œì„±í™”
          document.getElementById("btnRouter").disabled = false;
          document.getElementById("btnSwitch").disabled = false;
          document.getElementById("btn9200").disabled = false;

          keepReading = true;
          readLoop(); // ë°ì´í„° ì½ê¸° ì‹œì‘
        } catch (err) {
          logToTerminal("[ERROR] ì—°ê²° ì‹¤íŒ¨: " + err);
        }
      }

      // --- 2. ë°ì´í„° ì½ê¸° ë£¨í”„ (ë°±ê·¸ë¼ìš´ë“œ) ---
      async function readLoop() {
        const textDecoder = new TextDecoderStream();
        const readableStreamClosed = port.readable.pipeTo(textDecoder.writable);
        reader = textDecoder.readable.getReader();

        try {
          while (true) {
            const { value, done } = await reader.read();
            if (done) break;
            if (value) {
              globalBuffer += value; // ë²„í¼ì— ë°ì´í„° ëˆ„ì 
              logToTerminal(value, true); // í™”ë©´ì— ì¶œë ¥
            }
          }
        } catch (error) {
          logToTerminal("[ERROR] Read Error: " + error);
        } finally {
          reader.releaseLock();
        }
      }

      // --- 3. ëª…ë ¹ ì „ì†¡ ë° ëŒ€ê¸° ì—”ì§„ (í•µì‹¬ ë¡œì§) ---
      async function writeToStream(data) {
        const textEncoder = new TextEncoderStream();
        const writableStreamClosed = textEncoder.readable.pipeTo(port.writable);
        const writer = textEncoder.writable.getWriter();
        await writer.write(data + "\r");
        writer.close();
      }

      // íŠ¹ì • ë¬¸ìì—´ì´ ë²„í¼ì— ë‚˜íƒ€ë‚  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¬ëŠ” í•¨ìˆ˜
      async function wait(pattern, timeoutSec = 30) {
        logToTerminal(`\n[WAITING] "${pattern}" ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...`);
        const startTime = Date.now();

        while (true) {
          // ë²„í¼ ê²€ì‚¬
          if (globalBuffer.includes(pattern)) {
            globalBuffer = ""; // ë²„í¼ ë¹„ìš°ê¸° (ì¤‘ë³µ ê°ì§€ ë°©ì§€)
            return true;
          }

          // íƒ€ì„ì•„ì›ƒ ì²´í¬
          if (Date.now() - startTime > timeoutSec * 1000) {
            logToTerminal(`\n[TIMEOUT] ${timeoutSec}ì´ˆ ë™ì•ˆì‘ë‹µì´ ì—†ìŠµë‹ˆë‹¤.`);
            return false;
          }

          await new Promise((r) => setTimeout(r, 100)); // 0.1ì´ˆ ëŒ€ê¸°
        }
      }

      function logToTerminal(msg, isRaw = false) {
        const term = document.getElementById("terminal");
        if (isRaw) {
          term.textContent += msg;
        } else {
          term.textContent += "\n" + msg;
        }
        term.scrollTop = term.scrollHeight; // ìë™ ìŠ¤í¬ë¡¤
      }

      // --- 4. ìë™í™” ì‹œë‚˜ë¦¬ì˜¤ (ë¬¸ì„œ ë‚´ìš© êµ¬í˜„) ---

      // A. Router Recovery Script [cite: 27-52]
      async function runRouterRecovery() {
        if (
          !confirm("ë¼ìš°í„° ë³µêµ¬ë¥¼ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (rommon 1 > ìƒíƒœì—¬ì•¼ í•¨)")
        )
          return;

        await writeToStream("confreg 0x2142");
        if (!(await wait("rommon 2 >"))) return;

        await writeToStream("reset");
        logToTerminal("[INFO] ì¬ë¶€íŒ… ì¤‘... (ì˜¤ë˜ ê±¸ë¦½ë‹ˆë‹¤)");

        // ì´ˆê¸° ì„¤ì • ëŒ€í™” ìƒì ê°ì§€
        if (!(await wait("initial configuration dialog", 600))) return; // 10ë¶„ ëŒ€ê¸°
        await writeToStream("no");

        if (!(await wait("Router>"))) return;
        await writeToStream("enable");

        if (!(await wait("Router#"))) return;
        await writeToStream("write erase");

        if (!(await wait("confirm"))) return;
        await writeToStream(""); // ì—”í„° ì…ë ¥

        await new Promise((r) => setTimeout(r, 2000)); // ì‚­ì œ ëŒ€ê¸°

        await writeToStream("configure terminal");
        if (!(await wait("(config)#"))) return;

        await writeToStream("config-register 0x2102");
        await writeToStream("end");

        if (!(await wait("Router#"))) return;
        await writeToStream("reload");

        // ì €ì¥ ì§ˆë¬¸ ì²˜ë¦¬ (ìˆ˜ì •ë¨)
        if (!(await wait("System configuration has been modified"))) return;
        await writeToStream("no");

        if (!(await wait("proceed"))) return;
        await writeToStream("");

        alert("ë¼ìš°í„° ë³µêµ¬ ì™„ë£Œ!");
      }

      // B. Switch Reset Script [cite: 112-163]
      async function runSwitchReset() {
        if (!confirm("ìŠ¤ìœ„ì¹˜ ì´ˆê¸°í™”ë¥¼ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (switch: ìƒíƒœì—¬ì•¼ í•¨)"))
          return;

        await writeToStream("delete flash:vlan.dat");
        if (!(await wait("(y/n)?"))) return;
        await writeToStream("y");

        await writeToStream("delete flash:config.text");
        if (!(await wait("(y/n)?"))) return;
        await writeToStream("y");

        await writeToStream("delete flash:private-config.text");
        // íŒŒì¼ì´ ì—†ì„ ìˆ˜ë„ ìˆìœ¼ë¯€ë¡œ ì§§ê²Œ ëŒ€ê¸° í›„ ê°•ì œ ì§„í–‰ ì‹œë„
        await new Promise((r) => setTimeout(r, 1000));
        await writeToStream("y");

        await writeToStream("reset");
        if (!(await wait("(y/n)?"))) return;
        await writeToStream("y");

        alert("ìŠ¤ìœ„ì¹˜ ì´ˆê¸°í™” ëª…ë ¹ ì™„ë£Œ! ì¬ë¶€íŒ…ë©ë‹ˆë‹¤.");
      }

      // C. 9200 Recovery Script [cite: 224-241]
      async function run9200Recovery() {
        if (
          !confirm("9200 ìŠ¤ìœ„ì¹˜ ë³µêµ¬ë¥¼ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (switch: ìƒíƒœì—¬ì•¼ í•¨)")
        )
          return;

        await writeToStream("SWITCH_IGNORE_STARTUP_CFG=1");
        await new Promise((r) => setTimeout(r, 500));
        await writeToStream("boot");

        logToTerminal("[INFO] ë¶€íŒ… ì¤‘... (ì•½ 5~10ë¶„ ì†Œìš”)");
        if (!(await wait("Switch>", 600))) return;

        await writeToStream("en");
        if (!(await wait("Switch#"))) return;

        await writeToStream("write erase");
        if (!(await wait("confirm"))) return;
        await writeToStream("");

        await writeToStream("conf t");
        if (!(await wait("(config)#"))) return;

        await writeToStream("no system ignore startupconfig switch all");
        await writeToStream("exit");

        if (!(await wait("Switch#"))) return;
        await writeToStream("write memory");
        await new Promise((r) => setTimeout(r, 3000)); // ì €ì¥ ëŒ€ê¸°

        await writeToStream("reload");
        // ì €ì¥ ì§ˆë¬¸ì´ ë‚˜ì˜¤ë©´ no
        await new Promise((r) => setTimeout(r, 2000));
        await writeToStream("no");
        await writeToStream(""); // í˜¹ì‹œ ëª¨ë¥¼ ì»¨íŒ ì—”í„°

        alert("9200 ë³µêµ¬ ì™„ë£Œ!");
      }
    </script>
  </body>
</html>
